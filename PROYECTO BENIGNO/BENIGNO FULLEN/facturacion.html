<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Facturación | Benigno</title>
  <link rel="stylesheet" href="static/css/facturacion.css">
</head>
<body>
  <div class="background-overlay"></div>

  <div class="facturacion-container">
    <div class="facturacion-box">
      <h2>Datos de Facturación</h2>
      <form id="form-facturacion">
        <label for="nombre">Nombre completo</label>
        <input type="text" id="nombre" name="nombre" required>

        <label for="telefono">Teléfono</label>
        <input type="text" id="telefono" name="telefono" required>

        <div id="campo-direccion" style="display: none;">
          <label for="direccion">Dirección y complementos</label>
          <input type="text" id="direccion" name="direccion">
        </div>

        <label for="metodo">Método de pago</label>
        <select id="metodo" name="metodo" required>
          <option value="">Selecciona</option>
          <option value="efectivo">Efectivo</option>
          <option value="transferencia">Transferencia</option>
        </select>

        <div id="campo-devuelta" style="display:none;">
          <label for="devuelta">¿Necesitas devuelta?</label>
          <input type="text" id="devuelta" name="devuelta" placeholder="Ej: ¿Con cuanto deseas pagar? ">
        </div>

        <label for="modificaciones">Modificaciones del pedido (opcional)</label>
        <textarea id="modificaciones" name="modificaciones" rows="3" placeholder="Ej: Sin pepinillos, salsa aparte..."></textarea>

        <div class="botones">
          <button type="submit" class="btn-confirmar">Confirmar pedido</button>
          <button type="button" class="btn-cancelar" onclick="window.location.href='/'">Cancelar</button>
        </div>
      </form>
    </div>

    <div class="resumen-box">
      <h2>Resumen del Pedido</h2>
      <div id="resumen-pedido"></div>

      <button 
        onclick="window.location.href='carrito.html'" 
        style="
          background-color:#e60000;
          color:#fff;
          border:none;
          padding:12px 20px;
          font-weight:700;
          border-radius:8px;
          cursor:pointer;
          width:100%;
          margin-top:20px;
          transition:background 0.3s ease;
        "
        onmouseover="this.style.backgroundColor='#ff1a1a'"
        onmouseout="this.style.backgroundColor='#e60000'">
        Volver al carrito
      </button>
    </div>
  </div>

  <footer class="footer-facturacion">
    <div class="footer-container">
      <h2 class="footer-title">BENIGNO</h2>
      <hr class="footer-line">
      <div class="footer-content">
        <p>© 2025 Benigno. Todos los derechos reservados.</p>
        <div class="footer-links">
          <a href="#">Menú</a> |
          <a href="#">Contacto</a> |
          <a href="#">Productos</a>
        </div>
        <p>Síguenos en:
          <a href="#">Instagram</a> |
          <a href="#">Facebook</a> |
          <a href="#">TikTok</a>
        </p>
      </div>
    </div>
  </footer>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const resumenContainer = document.getElementById("resumen-pedido");

    // Función para detectar tipo de entrega desde localStorage
    function readTipoEntrega() {
      return (
        localStorage.getItem("tipoEntrega") ||
        localStorage.getItem("tipoEnvio") ||
        localStorage.getItem("tipo_envio") ||
        "recoger"
      ).toLowerCase();
    }

    // Mostrar u ocultar campo dirección
    const tipoEntrega = readTipoEntrega();
    const campoDireccion = document.getElementById("campo-direccion");
    const inputDireccion = document.getElementById("direccion");

    if (tipoEntrega === "domicilio") {
      campoDireccion.style.display = "block";
      inputDireccion.required = true;
    } else {
      campoDireccion.style.display = "none";
      inputDireccion.required = false;
    }

    // Mostrar campo de devuelta solo si el método es efectivo
    const metodoSelect = document.getElementById("metodo");
    const campoDevuelta = document.getElementById("campo-devuelta");
    metodoSelect.addEventListener("change", () => {
      campoDevuelta.style.display = metodoSelect.value === "efectivo" ? "block" : "none";
      if (metodoSelect.value !== "efectivo") {
        document.getElementById("devuelta").value = "";
      }
    });

    // Render del resumen del pedido
    function normalizeItem(raw) {
      if (!raw) return null;
      const title = raw.title || raw.name || raw.nombre || "Producto";
      const priceNumber = parseInt(raw.priceNumber ?? raw.precio ?? raw.price ?? 0, 10) || 0;
      const cantidad = Number(raw.cantidad ?? raw.qty ?? 1);
      const img = raw.img || raw.image || raw.imagen || "";
      return { title, priceNumber, cantidad, img };
    }

    function renderResumen() {
      const carritoRaw = JSON.parse(localStorage.getItem("carrito_benigno") || "null");
      const productoSeleccionado = JSON.parse(localStorage.getItem("productoSeleccionado") || "null");
      let items = [];

      if (Array.isArray(carritoRaw) && carritoRaw.length > 0) {
        items = carritoRaw.map(normalizeItem).filter(Boolean);
      } else if (productoSeleccionado) {
        const n = normalizeItem(productoSeleccionado);
        if (n) items = [n];
      }

      if (!items.length) {
        resumenContainer.innerHTML = `<div style="color:#fff; text-align:center; padding:20px;">No hay productos en el pedido.</div>`;
        return;
      }

      let html = `<div class="pedido-list">`;
      let subtotalTotal = 0;

      items.forEach((it) => {
        const subtotalItem = it.priceNumber * it.cantidad;
        subtotalTotal += subtotalItem;
        html += `
          <div class="item-resumen" style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
            ${it.img ? `<img src="${it.img}" alt="${it.title}" style="width:70px; height:70px; object-fit:cover; border-radius:8px;">` : ""}
            <div style="flex:1">
              <div style="font-weight:700; color:#fff;">${it.title}</div>
              <div style="color:#ccc;">Precio unitario: $${it.priceNumber.toLocaleString()}</div>
              <div style="color:#ccc;">Cantidad: ${it.cantidad}</div>
            </div>
            <div style="text-align:right; color:#fff; font-weight:700;">$${(subtotalItem).toLocaleString()}</div>
          </div>
        `;
      });

      const envio = tipoEntrega === "domicilio" ? 3000 : 0;
      const total = subtotalTotal + envio;

      html += `
        <div style="border-top:1px solid rgba(255,255,255,0.06); margin-top:8px; padding-top:12px;">
          <div style="display:flex; justify-content:space-between; color:#ccc;">
            <div>Subtotal</div><div>$${subtotalTotal.toLocaleString()}</div>
          </div>
          <div style="display:flex; justify-content:space-between; color:#ccc; margin-top:6px;">
            <div>Tipo de entrega</div><div>${tipoEntrega === "domicilio" ? "Domicilio" : "Recoger en local"}</div>
          </div>
          <div style="display:flex; justify-content:space-between; color:#ccc; margin-top:6px;">
            <div>Envío</div><div>$${envio.toLocaleString()}</div>
          </div>
          <hr style="border:none; border-top:1px solid rgba(255,255,255,0.06); margin:10px 0;">
          <div style="display:flex; justify-content:space-between; font-weight:800; color:#ff3b3b;">
            <div>Total</div><div>$${total.toLocaleString()}</div>
          </div>
        </div>
      `;
      resumenContainer.innerHTML = html;
      resumenContainer.dataset.total = total;
    }

    renderResumen();

     // Construir descripción del pedido para backend (factura)
function construirDetallePedido() {
  const carritoRaw = JSON.parse(localStorage.getItem("carrito_benigno") || "null");
  const productoSeleccionado = JSON.parse(localStorage.getItem("productoSeleccionado") || "null");

  let items = [];

  if (Array.isArray(carritoRaw) && carritoRaw.length > 0) {
    items = carritoRaw.map(normalizeItem).filter(Boolean);
  } else if (productoSeleccionado) {
    const n = normalizeItem(productoSeleccionado);
    if (n) items = [n];
  }

  if (!items.length) return "Sin detalle de productos";

  let detalle = "";
  items.forEach(it => {
    detalle += `${it.title} x${it.cantidad} ($${it.priceNumber.toLocaleString()})\n`;
  });

  detalle += `\nEntrega: ${tipoEntrega === "domicilio" ? "Domicilio" : "Recoger en local"}`;

  return detalle;
}
 




    // Envío al backend
    const form = document.getElementById("form-facturacion");
    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const metodo_pago = metodoSelect.value;
      const nombre_cliente = document.getElementById("nombre").value.trim();
      const telefono = document.getElementById("telefono").value.trim();
      const direccion = inputDireccion.value.trim() || "";
      const devuelta = document.getElementById("devuelta").value.trim();
      const modificaciones = document.getElementById("modificaciones").value.trim();
      const total = resumenContainer.dataset.total || 0;

 fetch("guardar_pedido.php", {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({
    tipo_entrega: tipoEntrega,
    metodo_pago: metodo_pago,
    nombre_cliente,
    telefono,
    direccion,
    total,
    descripcion: construirDetallePedido()
  })
})
.then(res => res.json())
.then(data => {
  if (data.status === "ok") {
    if (data.status === "ok") {
  const idPedido = data.id;

  // Redirigir a la factura con el ID
  window.location.href = `factura.html?id=${idPedido}`;
}

  } else {
    alert("Error: " + data.message);
  }
})
.catch(err => {
  console.error(err);
  alert("Error al generar la factura. Intenta nuevamente");
});

 });
  });
  </script>
</body>
</html>
